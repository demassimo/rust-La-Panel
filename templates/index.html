<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rust Panel</title>
<style>
:root{
  --bg:#0b0e14; --surface:#0f131a; --panel:#121826; --sunken:#0b1017;
  --text:#e6edf3; --muted:#9aa4ad; --accent:#22d3ee; --accent-2:#7c3aed;
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --blue:#3b82f6;
  --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 20% -20%,rgba(124,58,237,.08),transparent 60%),
             radial-gradient(1000px 700px at 120% 0%,rgba(34,211,238,.06),transparent 60%),
             var(--bg);
 color:var(--text); font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Arial}
a{color:inherit}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:36px;height:36px;border-radius:10px;background:
  conic-gradient(from 200deg at 70% 40%, var(--accent), transparent 40%),
  conic-gradient(from 20deg at 30% 60%, var(--accent-2), transparent 55%);
box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), var(--shadow)}
.brand h1{margin:0;font-size:18px;letter-spacing:.3px}
.badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-size:12px}

.grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}

.card{background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 60%),var(--panel);
border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
.card .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.card .body{padding:16px}

.row{display:flex;flex-wrap:wrap;gap:10px}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#1a2332;color:#e8eef5;cursor:pointer;transition:transform .05s ease,opacity .2s}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.good{background:linear-gradient(180deg,#25d366,#1faa59)}
.btn.bad{background:linear-gradient(180deg,#ef4444,#b91c1c)}
.btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309)}
.btn.blue{background:linear-gradient(180deg,#60a5fa,#2563eb)}
.btn.purple{background:linear-gradient(180deg,#a78bfa,#7c3aed)}
.btn.ghost{background:#111827;border:1px solid rgba(255,255,255,.08);color:#cbd5e1}

.input, .url{width:100%;background:#0d121b;border:1px solid rgba(255,255,255,.08);color:#e6edf3;border-radius:10px;padding:10px 12px}
.small{color:var(--muted);font-size:12px}

.kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;font-size:12px}
.pill.ok{background:rgba(34,197,94,.15);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.pill.err{background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.25)}

pre#logs{margin:0;background:linear-gradient(180deg,rgba(0,0,0,.3),transparent 40%),#0b1017;
border-top:1px solid rgba(255,255,255,.06);
font:12.5px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#cbd5e1;
max-height:68vh; overflow:auto; padding:14px}

.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.toolbar .group{display:flex;gap:8px;align-items:center}
label{font-size:12px;color:var(--muted)}
.input-inline{width:110px}

.metrics-card .body{display:flex;flex-direction:column;gap:12px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.stat{padding:12px;border-radius:12px;background:#0d121b;border:1px solid rgba(255,255,255,.06)}
.stat strong{display:block;margin-bottom:4px;font-size:13px;color:#e6edf3}
.stat span{font-size:13px;color:var(--muted)}
.metrics-status{font-size:12px;color:var(--muted)}
.metrics-status.error{color:#fca5a5}
.backup-actions{display:flex;gap:10px;flex-wrap:wrap}
.backup-list{display:flex;flex-direction:column;gap:8px}
.backup-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:12px;background:#0d121b;border:1px solid rgba(255,255,255,.06);flex-wrap:wrap}
.backup-item .meta{display:flex;flex-direction:column;font-size:12px;color:var(--muted)}
.backup-item .meta strong{color:#e6edf3;font-size:13px}
.backup-empty{padding:12px;border-radius:12px;background:#0d121b;border:1px solid rgba(255,255,255,.05);color:var(--muted);font-size:13px;text-align:center}

.toggle-line{display:flex;align-items:center;gap:12px;margin-top:8px;padding:10px 12px;background:#0d121b;border:1px solid rgba(255,255,255,.06);border-radius:12px}
.toggle-line input[type="checkbox"]{appearance:none;position:relative;width:44px;height:24px;border-radius:999px;background:#1f2937;border:1px solid rgba(255,255,255,.12);transition:background .2s ease, border-color .2s ease;cursor:pointer}
.toggle-line input[type="checkbox"]::after{content:"";position:absolute;top:2px;left:3px;width:18px;height:18px;border-radius:50%;background:#cbd5e1;transition:transform .2s ease,background .2s ease}
.toggle-line input[type="checkbox"]:checked{background:linear-gradient(180deg,#22d3ee,#0ea5e9);border-color:rgba(34,211,238,.6)}
.toggle-line input[type="checkbox"]:checked::after{transform:translateX(18px);background:#0f172a}
.toggle-line .text{flex:1;font-size:13px;color:#d1d9e6}
.toggle-line .text span{display:block;font-size:12px;color:var(--muted);margin-top:2px}
.small-link{color:var(--accent);text-decoration:none}
.small-link:hover{text-decoration:underline}

.footer{margin-top:14px;padding:10px 16px;background:var(--sunken);border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}

/* Toasts */
.toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:60}
.toast .t{padding:10px 12px;border-radius:10px;background:#0f172a;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow);min-width:240px}
.t.ok{border-color:rgba(34,197,94,.4)} .t.err{border-color:rgba(239,68,68,.4)}
/* Spinner */
.spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.file-card{grid-column:1 / -1}
.file-body{display:flex;gap:0;border-top:1px solid rgba(255,255,255,.05)}
@media (max-width:980px){.file-body{flex-direction:column}}
.file-sidebar{width:260px;max-width:100%;background:rgba(15,19,26,.7);border-right:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column}
.file-toolbar{padding:12px 14px;display:flex;flex-direction:column;gap:8px;border-bottom:1px solid rgba(255,255,255,.05)}
.file-toolbar .path{font-size:12px;color:var(--muted);word-break:break-all}
.file-list{flex:1;overflow:auto}
.file-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer;transition:background .12s ease}
.file-row:hover{background:rgba(255,255,255,.04)}
.file-row.dir strong::before{content:"\1F4C1\0020"}
.file-row.file strong::before{content:"\1F4C4\0020"}
.file-row.blocked{opacity:.55;cursor:not-allowed}
.file-row.blocked strong::before{content:"\1F6AB\0020"}
.file-size{font-size:12px;color:var(--muted)}
.file-editor{flex:1;display:flex;flex-direction:column}
.file-editor-head{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;justify-content:space-between;align-items:center;gap:12px}
.file-editor-head .name{font-weight:600;font-size:13px;word-break:break-all}
#fileContent{flex:1;padding:16px;background:var(--sunken);color:var(--text);border:0;font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;resize:none;min-height:260px}
.file-empty{padding:24px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <h1>Rust Panel</h1>
      <span class="badge">service: <b>{{service}}</b></span>
    </div>
    <div class="row" style="gap:10px">
      <a href="{{ url_for('config_page') }}" class="btn ghost" style="padding:8px 12px">Config</a>
      <div class="badge" id="pill">checkingâ€¦</div>
      <form action="{{ url_for('logout') }}" method="post" style="margin:0">
        <button type="submit" class="btn ghost" style="padding:8px 12px">Logout</button>
      </form>
    </div>
  </div>

  <div class="grid">
    <!-- Controls -->
    <section class="card">
      <div class="head"><strong>Controls</strong></div>
      <div class="body">
        <div class="row" style="margin-bottom:10px">
          <button id="start" class="btn good">Start</button>
          <button id="stop" class="btn bad">Stop</button>
          <button id="restart" class="btn warn">Restart</button>
        </div>

        <div class="row" style="margin:12px 0 6px">
          <button id="installRust" class="btn blue">Install Rust Server</button>
          <button id="updateRust" class="btn blue">Update Rust</button>
        </div>

        <div class="row" style="margin:12px 0 6px">
          <input id="oxideUrl" class="url" value="{{ default_oxide_url }}" data-default-url="{{ default_oxide_url }}" placeholder="Direct ZIP URL for Oxide/uMod or Carbon (Linux build)">
          <button id="updateOxide" class="btn purple">Install/Update Oxide</button>
        </div>

        <label class="toggle-line" for="autoRustToggle">
          <input id="autoRustToggle" type="checkbox" {% if auto_download %}checked{% endif %}>
          <div class="text">
            Auto-download Rust before running the Oxide installer
            <span>Manage paths on the <a class="small-link" href="{{ url_for('config_page') }}">config page</a>.</span>
          </div>
        </label>

        <div class="toolbar" style="margin-top:6px">
          <div class="group">
            <label for="tailN">Last</label>
            <input id="tailN" class="input input-inline" type="number" value="300" min="50" max="3000">
          </div>
          <div class="group">
            <label for="since">Since</label>
            <input id="since" class="input input-inline" type="text" placeholder="e.g. 15m, 2h">
          </div>
          <button id="reloadLogs" class="btn ghost">Reload Logs</button>
        </div>

        <p class="small" style="margin-top:8px">
          Tip: keep Oxide/Carbon ZIPs for Linux only. Rust updates use SteamCMD and will validate files.
        </p>
      </div>
    </section>

    <!-- Status & Logs -->
    <section class="card">
      <div class="head"><strong>Status & Console</strong></div>
      <div class="body" style="padding:0">
        <div id="statusBox" style="padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)">
          <div id="statusText" class="small">Fetching statusâ€¦</div>
        </div>
        <pre id="logs">Loading logsâ€¦</pre>
      </div>
      <div class="footer">
        <span>Live console (SSE). Auto-updates every 4s for status.</span>
        <span id="busy" style="display:none;gap:8px;align-items:center"><span class="spinner"></span> Workingâ€¦</span>
      </div>
    </section>

    <!-- Metrics -->
    <section class="card metrics-card">
      <div class="head"><strong>Server Metrics</strong></div>
      <div class="body">
        <div class="stat-grid">
          <div class="stat">
            <strong>CPU Load</strong>
            <span id="metricLoad">Loadingâ€¦</span>
          </div>
          <div class="stat">
            <strong>Memory</strong>
            <span id="metricMemory">Loadingâ€¦</span>
          </div>
          <div class="stat">
            <strong>Disk Usage</strong>
            <span id="metricDisk">Loadingâ€¦</span>
          </div>
        </div>
        <div class="metrics-status" id="metricsStatus">Collecting server metricsâ€¦</div>
      </div>
    </section>

    <!-- Backups -->
    <section class="card">
      <div class="head"><strong>Backups</strong></div>
      <div class="body" style="display:flex;flex-direction:column;gap:12px">
        <div class="backup-actions">
          <button id="createBackup" class="btn blue">Create Backup</button>
          <button id="refreshBackups" class="btn ghost">Refresh List</button>
        </div>
        <p class="small" id="backupLocation">Backups stored in {{ backups_path }} (relative to the server root).</p>
        <div class="metrics-status" id="backupInfo"></div>
        <div class="backup-list" id="backupList"></div>
        <p class="small">Backups are tar.gz archives. Download or move them from the file manager under <code>/backups</code>.</p>
      </div>
    </section>

    <!-- File Manager -->
    <section class="card file-card">
      <div class="head"><strong>File Manager</strong><span class="small">Root: {{ file_root }}</span></div>
      <div class="body" style="padding:0">
        <div class="file-body">
          <div class="file-sidebar">
            <div class="file-toolbar">
              <div style="font-weight:600;font-size:13px">Current folder</div>
              <div class="path" id="filePath">/</div>
              <button id="reloadFiles" class="btn ghost" style="width:100%">Reload</button>
            </div>
            <div class="file-list" id="fileList"></div>
          </div>
          <div class="file-editor">
            <div class="file-editor-head">
              <div class="name" id="fileName">Select a text file to view/edit</div>
              <button id="saveFile" class="btn blue" disabled>Save</button>
            </div>
            <textarea id="fileContent" spellcheck="false" style="display:none" disabled></textarea>
            <div class="file-empty" id="fileEmpty">Select a text file from the list to view or edit it.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const btns = ['#start','#stop','#restart','#installRust','#updateRust','#updateOxide','#reloadLogs'].map(s=>$(s));
const busy = $('#busy'), pill = $('#pill');
const autoRustToggle = $('#autoRustToggle');

const fileListEl = $('#fileList');
const filePathEl = $('#filePath');
const fileNameEl = $('#fileName');
const fileContentEl = $('#fileContent');
const fileEmptyEl = $('#fileEmpty');
const defaultFileMessage = fileEmptyEl ? fileEmptyEl.textContent : '';
const saveFileBtn = $('#saveFile');
const reloadFilesBtn = $('#reloadFiles');
const metricLoadEl = $('#metricLoad');
const metricMemoryEl = $('#metricMemory');
const metricDiskEl = $('#metricDisk');
const metricsStatusEl = $('#metricsStatus');
const backupListEl = $('#backupList');
const backupInfoEl = $('#backupInfo');
const backupLocationEl = $('#backupLocation');
const createBackupBtn = $('#createBackup');
const refreshBackupsBtn = $('#refreshBackups');

const blockedExt = new Set(['.dll','.exe','.png','.jpg','.jpeg','.gif','.bmp','.ico','.webp','.tiff','.svg','.dds','.tga','.psd','.mp3','.wav','.ogg','.flac','.mp4','.avi','.mov','.mkv','.pak','.bin','.dat']);

let currentDir = '';
let currentFile = '';
let fileDirty = false;
let fsLoading = false;

function setBusy(v){ busy.style.display = v ? 'flex':'none'; btns.forEach(b=>b.disabled=v); }
function toast(msg, ok=true){
  const t = document.createElement('div'); t.className = 't '+(ok?'ok':'err'); t.textContent = msg;
  $('#toast').appendChild(t); setTimeout(()=>{t.style.opacity='0'; t.style.transform='translateY(6px)'; setTimeout(()=>t.remove(),300)}, 2600);
}
async function API(path,opts={}){
  const options = Object.assign({credentials:'same-origin'}, opts);
  options.headers = Object.assign({'Content-Type':'application/json'}, options.headers||{});
  const r = await fetch(path, options);
  if(r.status === 401){
    window.location = '/login?next='+encodeURIComponent(window.location.pathname);
    throw new Error('unauthorized');
  }
  const text = await r.text();
  let data = {};
  if(text){
    try{ data = JSON.parse(text); }
    catch{ data = {raw:text}; }
  }
  if(!r.ok){
    const msg = (data && data.error) ? data.error : ('HTTP '+r.status);
    const err = new Error(msg);
    err.status = r.status;
    err.payload = data;
    throw err;
  }
  return data;
}

function joinPath(dir,name){
  if(!dir) return name;
  return dir.replace(/\\/g,'/').replace(/\/+$/,'') + '/' + name;
}

function displayPath(path){
  const clean = path ? path.replace(/\\/g,'/') : '';
  return '/' + clean;
}

function formatSize(size){
  if(size === null || size === undefined) return '';
  if(size < 1024) return size + ' B';
  if(size < 1024 * 1024) return (size/1024).toFixed(1) + ' KB';
  if(size < 1024 * 1024 * 1024) return (size/1048576).toFixed(1) + ' MB';
  return (size/1073741824).toFixed(1) + ' GB';
}

function formatPercent(value){
  if(value === null || value === undefined || Number.isNaN(value)) return '';
  return value.toFixed(1) + '%';
}

function confirmDiscard(){
  if(!fileDirty) return true;
  return confirm('You have unsaved changes. Discard them?');
}

function resetEditor(message){
  currentFile = '';
  fileNameEl.textContent = 'Select a text file to view/edit';
  fileContentEl.value = '';
  fileContentEl.disabled = true;
  fileContentEl.style.display = 'none';
  fileEmptyEl.style.display = 'block';
  fileEmptyEl.textContent = message || defaultFileMessage;
  markDirty(false);
}

function setFileBusy(v){
  fsLoading = v;
  reloadFilesBtn.disabled = v;
  fileListEl.style.opacity = v ? 0.6 : 1;
  fileListEl.style.pointerEvents = v ? 'none' : 'auto';
  saveFileBtn.disabled = v || !currentFile || !fileDirty;
}

function markDirty(v){
  fileDirty = v;
  saveFileBtn.disabled = fsLoading || !currentFile || !fileDirty;
}

function renderFileList(data){
  currentDir = data.path || '';
  filePathEl.textContent = displayPath(currentDir);
  fileListEl.innerHTML = '';

  if(data.parent !== null && data.parent !== undefined){
    const up = document.createElement('div');
    up.className = 'file-row dir';
    const strong = document.createElement('strong');
    strong.textContent = '..';
    up.appendChild(strong);
    up.onclick = ()=>{ if(fsLoading) return; if(!confirmDiscard()) return; resetEditor(); loadDir(data.parent || ''); };
    fileListEl.appendChild(up);
  }

  if(!data.entries || !data.entries.length){
    const empty = document.createElement('div');
    empty.className = 'file-empty';
    empty.textContent = 'Folder is empty';
    fileListEl.appendChild(empty);
    return;
  }

  data.entries.forEach(entry=>{
    const row = document.createElement('div');
    row.className = 'file-row ' + (entry.is_dir?'dir':'file');
    const strong = document.createElement('strong');
    strong.textContent = entry.name;
    row.appendChild(strong);
    if(!entry.is_dir){
      const size = document.createElement('span');
      size.className = 'file-size';
      size.textContent = formatSize(entry.size);
      row.appendChild(size);
    }

    if(entry.is_dir){
      row.onclick = ()=>{ if(fsLoading) return; if(!confirmDiscard()) return; resetEditor(); loadDir(joinPath(currentDir, entry.name)); };
    }else{
      const ext = entry.name.includes('.') ? entry.name.substring(entry.name.lastIndexOf('.')).toLowerCase() : '';
      if(blockedExt.has(ext)){
        row.classList.add('blocked');
        row.onclick = ()=> toast('Binary files cannot be opened in the editor.', false);
      }else{
        row.onclick = ()=> openFile(joinPath(currentDir, entry.name), entry.name);
      }
    }

    fileListEl.appendChild(row);
  });
}

async function loadDir(path=''){
  setFileBusy(true);
  try{
    const data = await API('/api/fs/list?path='+encodeURIComponent(path));
    renderFileList(data);
  }catch(e){
    toast('File list failed: '+e.message, false);
  }finally{
    setFileBusy(false);
  }
}

async function openFile(path, name){
  if(fsLoading) return;
  if(!confirmDiscard()) return;
  setFileBusy(true);
  try{
    const data = await API('/api/fs/file?path='+encodeURIComponent(path));
    currentFile = path;
    fileNameEl.textContent = name;
    fileContentEl.value = data.content || '';
    fileContentEl.disabled = false;
    fileContentEl.style.display = 'block';
    fileEmptyEl.style.display = 'none';
    markDirty(false);
  }catch(e){
    resetEditor('Unable to open file: '+e.message);
    toast('Open failed: '+e.message, false);
  }finally{
    setFileBusy(false);
  }
}

async function saveFile(){
  if(!currentFile || fsLoading) return;
  setFileBusy(true);
  try{
    await API('/api/fs/file', {method:'POST', body: JSON.stringify({path: currentFile, content: fileContentEl.value})});
    markDirty(false);
    toast('File saved successfully.');
  }catch(e){
    toast('Save failed: '+e.message, false);
  }finally{
    setFileBusy(false);
  }
}

async function refreshStatus(){
  try{
    const r = await API('/api/status');
    const ok = !!r.ok;
    $('#statusText').textContent = (ok?'Status: OK\n\n':'Status: Error\n\n') + (r.output||'');
    pill.className = 'badge pill '+(ok?'ok':'err');
    pill.textContent = ok ? 'running' : 'stopped / error';
  }catch(e){
    $('#statusText').textContent = 'Status fetch failed: '+e.message;
    pill.className = 'badge pill err'; pill.textContent = 'unreachable';
  }
}

async function refreshMetrics(){
  if(!metricLoadEl) return;
  try{
    const r = await API('/api/metrics');
    if(r.load){
      metricLoadEl.textContent = `${Number(r.load["1"]).toFixed(2)} / ${Number(r.load["5"]).toFixed(2)} / ${Number(r.load["15"]).toFixed(2)}`;
    }
    if(r.memory){
      metricMemoryEl.textContent = `${formatSize(r.memory.used)} of ${formatSize(r.memory.total)} (${formatPercent(r.memory.percent)})`;
    }
    if(r.disk){
      metricDiskEl.textContent = `${formatSize(r.disk.used)} of ${formatSize(r.disk.total)} (${formatPercent(r.disk.percent)})`;
    }
    if(metricsStatusEl){
      metricsStatusEl.classList.remove('error');
      metricsStatusEl.textContent = 'Last updated ' + new Date().toLocaleTimeString();
    }
  }catch(e){
    if(metricsStatusEl){
      metricsStatusEl.classList.add('error');
      metricsStatusEl.textContent = 'Metrics unavailable: ' + e.message;
    }
  }
}

function setBackupBusy(v){
  if(createBackupBtn) createBackupBtn.disabled = v;
  if(refreshBackupsBtn) refreshBackupsBtn.disabled = v;
  if(backupListEl) backupListEl.style.opacity = v ? 0.6 : 1;
}

function renderBackups(list){
  if(!backupListEl) return;
  backupListEl.innerHTML = '';
  if(!list || !list.length){
    const empty = document.createElement('div');
    empty.className = 'backup-empty';
    empty.textContent = 'No backups yet.';
    backupListEl.appendChild(empty);
    return;
  }

  list.forEach(item=>{
    const row = document.createElement('div');
    row.className = 'backup-item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('strong');
    name.textContent = item.name;
    const detail = document.createElement('span');
    const size = formatSize(item.size);
    const when = item.modified ? new Date(item.modified * 1000).toLocaleString() : '';
    detail.textContent = `${size}${when ? ' â€¢ ' + when : ''}`;
    meta.appendChild(name);
    meta.appendChild(detail);
    row.appendChild(meta);

    const actions = document.createElement('div');
    actions.className = 'backup-actions';
    const del = document.createElement('button');
    del.className = 'btn ghost';
    del.style.padding = '6px 12px';
    del.textContent = 'Delete';
    del.onclick = ()=> deleteBackup(item.name);
    actions.appendChild(del);
    row.appendChild(actions);

    backupListEl.appendChild(row);
  });
}

async function loadBackups(opts={}){
  if(!backupListEl) return;
  if(backupInfoEl){
    backupInfoEl.textContent = 'Refreshing backupsâ€¦';
    backupInfoEl.classList.remove('error');
  }
  const showBusy = !!opts.busy;
  if(showBusy) setBackupBusy(true);
  try{
    const data = await API('/api/backups');
    if(backupLocationEl && data.path !== undefined){
      backupLocationEl.textContent = 'Backups stored in ' + displayPath(data.path || '') + ' (relative to the server root).';
    }
    renderBackups(data.backups || []);
    if(backupInfoEl){
      backupInfoEl.textContent = 'Last refreshed ' + new Date().toLocaleTimeString();
    }
  }catch(e){
    if(backupInfoEl){
      backupInfoEl.textContent = 'Unable to load backups: ' + e.message;
      backupInfoEl.classList.add('error');
    }
  }finally{
    if(showBusy) setBackupBusy(false);
  }
}

async function deleteBackup(name){
  if(!name) return;
  if(!confirm('Delete backup "' + name + '"?')) return;
  setBackupBusy(true);
  try{
    await API('/api/backups/' + encodeURIComponent(name), {method:'DELETE'});
    toast('Backup deleted.');
    await loadBackups();
  }catch(e){
    toast('Delete failed: ' + e.message, false);
  }finally{
    setBackupBusy(false);
  }
}

let es;
function startLogs(){
  if(es) es.close();
  const n = $('#tailN').value || '300';
  const since = $('#since').value || '';
  const url = '/api/logs?n='+encodeURIComponent(n)+(since?('&since='+encodeURIComponent(since)):'');
  $('#logs').textContent = ''; // clear
  es = new EventSource(url, {withCredentials:true});
  es.onmessage = (e)=>{ $('#logs').textContent += (e.data||'')+"\n"; const el=$('#logs'); el.scrollTop=el.scrollHeight; };
  es.onerror = ()=>{ $('#logs').textContent += "\n[connection lost â€” click Reload Logs]\n"; es.close(); };
}

async function action(act){
  setBusy(true);
  try{
    const r = await API('/api/'+act, {method:'POST'});
    toast((r.ok?'Success: ':'Error: ')+(r.output||r.exit), r.ok);
    await refreshStatus();
  }catch(e){ toast('Request failed: '+e.message, false) }
  finally{ setBusy(false); }
}

$('#start').onclick   = ()=>action('start');
$('#stop').onclick    = ()=>action('stop');
$('#restart').onclick = ()=>action('restart');

$('#updateRust').onclick = async ()=>{
  setBusy(true);
  try{
    const r = await API('/api/update_rust', {method:'POST'});
    toast((r.ok?'Rust updated: ':'Update failed: ')+(r.output||r.exit), r.ok);
    await refreshStatus();
  }catch(e){ toast('Rust update failed: '+e.message, false) }
  finally{ setBusy(false); }
};

$('#installRust').onclick = async ()=>{
  if(!confirm('Install/validate the Rust Dedicated Server using SteamCMD?')) return;
  setBusy(true);
  try{
    const r = await API('/api/install_rust', {method:'POST'});
    toast((r.ok?'Rust installed: ':'Install failed: ')+(r.output||r.exit), r.ok);
    await refreshStatus();
  }catch(e){ toast('Rust install failed: '+e.message, false) }
  finally{ setBusy(false); }
};

$('#updateOxide').onclick = async ()=>{
  const input = $('#oxideUrl');
  const url = (input.value || input.dataset.defaultUrl || '').trim();
  if(!url){ toast('Paste a direct Linux ZIP URL for Oxide/Carbon', false); return; }
  setBusy(true);
  try{
    const r = await API('/api/update_oxide', {method:'POST', body: JSON.stringify({url})});
    toast((r.ok?'Oxide updated: ':'Oxide update failed: ')+(r.output||r.exit), r.ok);
    await refreshStatus();
  }catch(e){ toast('Oxide update failed: '+e.message, false) }
  finally{ setBusy(false); }
};

$('#reloadLogs').onclick = ()=> startLogs();

if(fileContentEl){
  fileContentEl.addEventListener('input', ()=> markDirty(true));
}
saveFileBtn.onclick = ()=> saveFile();
reloadFilesBtn.onclick = ()=>{ if(fsLoading) return; loadDir(currentDir); };
if(refreshBackupsBtn){
  refreshBackupsBtn.onclick = ()=> loadBackups({busy:true});
}
if(createBackupBtn){
  createBackupBtn.onclick = async ()=>{
    const label = prompt('Optional label for this backup (letters, numbers, dashes, and underscores only):','');
    const payload = label && label.trim() ? {label: label.trim()} : {};
    setBackupBusy(true);
    try{
      const r = await API('/api/backups', {method:'POST', body: JSON.stringify(payload)});
      toast('Backup created: ' + (r.backup ? r.backup.name : 'success'));
      await loadBackups();
    }catch(e){
      toast('Backup failed: ' + e.message, false);
    }finally{
      setBackupBusy(false);
    }
  };
}
resetEditor();
loadDir();

refreshStatus();
refreshMetrics();
startLogs();
setInterval(refreshStatus, 4000);
setInterval(refreshMetrics, 10000);
loadBackups();

if(autoRustToggle){
  autoRustToggle.addEventListener('change', async ()=>{
    const desired = autoRustToggle.checked;
    autoRustToggle.disabled = true;
    try{
      await API('/api/config', {method:'POST', body: JSON.stringify({auto_download_rust_with_oxide: desired})});
      toast('Oxide auto-download setting updated.');
    }catch(e){
      autoRustToggle.checked = !desired;
      toast('Failed to update setting: '+e.message, false);
    }finally{
      autoRustToggle.disabled = false;
    }
  });
}
</script>
</body>
</html>
